<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Recomendação Híbrida</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilização para o texto pré-formatado */
        .pre-scrollable {
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-xl p-8 space-y-6">
        <h1 class="text-3xl font-bold text-center text-indigo-700">
            Teste de Personalização Híbrida
        </h1>
        <p class="text-gray-600 text-center">
            Envie requisições ao seu backend Render para verificar a lógica de personalização com o histórico (`user_test_001`).
        </p>

        <!-- 1. Configuração da URL da API -->
        <div>
            <label for="apiUrl" class="block text-sm font-medium text-gray-700 mb-1">
                URL do Backend (Serviço Render):
            </label>
            <input type="url" id="apiUrl" value="SUA_URL_DO_RENDER"
                   placeholder="Ex: https://seurecomendador.onrender.com"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm">
        </div>

        <!-- 2. Preferências de Busca -->
        <div>
            <label for="preferences" class="block text-sm font-medium text-gray-700 mb-1">
                Preferências (Ex: Filmes de aventura, como Indiana Jones)
            </label>
            <textarea id="preferences" rows="2"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm resize-none">Filmes de aventura, como Indiana Jones.</textarea>
        </div>

        <!-- 3. Parâmetros de Chamada -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label for="userId" class="block text-sm font-medium text-gray-700 mb-1">
                    User ID (Histórico: Interstellar, Gravidade)
                </label>
                <input type="text" id="userId" value="user_test_001"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed">
            </div>
            <div>
                <label for="limit" class="block text-sm font-medium text-gray-700 mb-1">
                    Limite de Recomendações
                </label>
                <input type="number" id="limit" value="5" min="1" max="20"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm">
            </div>
        </div>

        <!-- Botão de Envio -->
        <button id="submitBtn"
                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 disabled:bg-indigo-400">
            Buscar Recomendações Híbridas
        </button>

        <!-- Área de Resultados -->
        <div id="resultsArea" class="hidden">
            <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Resultados</h2>
            <div id="loadingIndicator" class="hidden text-center text-indigo-600 font-medium">
                ⏳ Buscando e Personalizando...
            </div>
            
            <div id="recommendationsList" class="space-y-3">
                <!-- Recomendações serão inseridas aqui -->
            </div>
            
            <div id="rawResponse" class="mt-6">
                <h3 class="text-lg font-medium text-gray-700 mb-2">Resposta Completa (JSON)</h3>
                <pre class="bg-gray-100 p-4 rounded-lg text-xs pre-scrollable text-red-700" id="jsonOutput">Aguardando resultado...</pre>
            </div>
        </div>
        
        <!-- Área de Mensagens (para erros) -->
        <div id="messageBox" class="hidden p-4 rounded-lg text-sm font-medium" role="alert"></div>

    </div>

    <script>
        const apiUrlInput = document.getElementById('apiUrl');
        const preferencesInput = document.getElementById('preferences');
        const userIdInput = document.getElementById('userId');
        const limitInput = document.getElementById('limit');
        const submitBtn = document.getElementById('submitBtn');
        const resultsArea = document.getElementById('resultsArea');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const recommendationsList = document.getElementById('recommendationsList');
        const jsonOutput = document.getElementById('jsonOutput');
        const messageBox = document.getElementById('messageBox');

        function showMessage(message, type = 'error') {
            messageBox.textContent = message;
            messageBox.className = `p-4 rounded-lg text-sm font-medium ${type === 'error' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
            messageBox.classList.remove('hidden');
        }

        function displayRecommendations(recs) {
            recommendationsList.innerHTML = '';
            if (recs.length === 0) {
                recommendationsList.innerHTML = '<p class="text-gray-500">Nenhuma recomendação encontrada.</p>';
                return;
            }

            recs.forEach((rec, index) => {
                const item = rec.item;
                const score = (rec.score * 100).toFixed(2); // Score em percentual
                
                const recElement = document.createElement('div');
                recElement.className = 'p-4 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition duration-150';
                recElement.innerHTML = `
                    <p class="text-lg font-semibold text-indigo-600">${index + 1}. ${item.title}</p>
                    <p class="text-sm text-gray-700 mt-1">${item.description}</p>
                    <div class="mt-2 text-xs text-gray-500 space-y-1">
                        <p><strong>Plataforma:</strong> ${item.platform}</p>
                        <p><strong>Duração:</strong> ${item.duration_minutes ? item.duration_minutes + ' min' : 'N/A'}</p>
                        <p class="font-bold text-green-600">Pontuação Híbrida: ${score}%</p>
                    </div>
                `;
                recommendationsList.appendChild(recElement);
            });
        }

        submitBtn.addEventListener('click', async () => {
            const apiUrl = apiUrlInput.value.trim().replace(/\/$/, ""); // Remove barra final
            const preferences = preferencesInput.value.trim();
            const userId = userIdInput.value.trim();
            const limit = parseInt(limitInput.value.trim());

            messageBox.classList.add('hidden');
            resultsArea.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            submitBtn.disabled = true;
            jsonOutput.textContent = 'Aguardando resultado...';
            recommendationsList.innerHTML = '';
            
            if (!apiUrl || apiUrl === "SUA_URL_DO_RENDER") {
                showMessage("Por favor, insira a URL real do seu serviço Render.");
                loadingIndicator.classList.add('hidden');
                submitBtn.disabled = false;
                return;
            }

            const endpointUrl = `${apiUrl}/recommend?user_id=${userId}&strategy=hybrid`;
            
            const requestBody = {
                preferences: preferences,
                platforms: null,
                max_duration_minutes: null,
                limit: limit
            };

            try {
                const response = await fetch(endpointUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                jsonOutput.textContent = JSON.stringify(data, null, 2);
                resultsArea.classList.remove('hidden');

                if (response.ok) {
                    displayRecommendations(data);
                    jsonOutput.classList.remove('text-red-700');
                    jsonOutput.classList.add('text-gray-800');
                    showMessage("Busca concluída com sucesso! Verifique a lista.", 'success');

                } else {
                    // Trata erros HTTP (4xx, 5xx) retornados pelo FastAPI
                    const detail = data.detail ? (Array.isArray(data.detail) ? data.detail[0].msg : data.detail) : 'Erro desconhecido.';
                    showMessage(`Erro da API (${response.status}): ${detail}`);
                    jsonOutput.classList.add('text-red-700');
                    jsonOutput.classList.remove('text-gray-800');
                }

            } catch (error) {
                showMessage(`Erro de conexão: Não foi possível alcançar o servidor. Verifique a URL e o status do Render. Detalhes: ${error.message}`);
                jsonOutput.textContent = `Erro de Conexão: ${error.message}`;
            } finally {
                loadingIndicator.classList.add('hidden');
                submitBtn.disabled = false;
            }
        });

    </script>

</body>
</html>
